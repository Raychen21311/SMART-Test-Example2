<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Healthcare Utilization & Coverage</title>

  <script src="https://cdn.jsdelivr.net/npm/fhirclient/build/fhir-client.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
  <script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1"></script>
  <link rel="stylesheet" href="css/theme.css">
  <link rel="stylesheet" href="css/theme.css">

</head>

<body>
  <div class="page">
    <div class="topbar">
      <div class="brand">
        <div class="brand-badge">PH</div>
        <div class="brand-title">
          <div class="t1">Patient Health Dashboard</div>
          <div class="t2">Healthcare Utilization & Coverage</div>
        </div>
      </div>

      <div class="tabs" aria-label="tabs">
        <a class="tab" href="overview.html">Overview</a>
        <a class="tab" href="timeline.html">Timeline</a>
        <a class="tab" href="labs.html">Labs & Reports</a>
        <a class="tab" href="careplan.html">CarePlan</a>
        <a class="tab active" href="utilization.html">Utilization</a>
      </div>

      <div class="top-actions">
        <div class="pill" title="目前病人資訊">
          <span class="dot" id="readyDot"></span>
          <span style="color:var(--muted)">ID:</span>
          <code id="pId">—</code>
        </div>
        <button class="btn" onclick="returnToSelect()">重新選擇病人</button>
      </div>
    </div>

    <h1>Healthcare Utilization & Coverage</h1>
    <p id="loadHint" style="color:var(--muted); font-weight:800">就醫次數&就醫機構型態</p>

    <div class="item" id="statusBanner" style="margin: 10px 0 14px;">
    </div>

    <div class="patient-card">
      <div class="patient-block">
        <div class="name" id="pName"><span class="skeleton" style="display:inline-block;width:220px;"></span></div>
        <div class="meta">
          ID: <span id="pId_dup">（同上）</span> ｜ 性別: <span id="pGender">—</span> ｜ 生日: <span id="pBirth">—</span>
        </div>
    </div>

    <div class="summary-grid">
      <div class="card">
        <div class="k">Total Encounters</div>
        <div class="v" id="kpiEnc">—</div>
        <div class="d">就醫總次數</div>
      </div>
      <div class="card">
        <div class="k">Total Claims</div>
        <div class="v" id="kpiClaim">—</div>
        <div class="d">申報/理賠事件</div>
      </div>
      <div class="card">
        <div class="k">Total EOB</div>
        <div class="v" id="kpiEob">—</div>
        <div class="d">給付結果紀錄</div>
      </div>
      <div class="card">
        <div class="k">Providers Involved</div>
        <div class="v" id="kpiProv">—</div>
        <div class="d">不同提供者</div>
      </div>
      <div class="card">
        <div class="k">Last Utilization</div>
        <div class="v" id="kpiLast">—</div>
        <div class="d">最近一次使用醫療日期</div>
      </div>
    </div>

    <div class="panel">
      <div class="section-head">
        <div class="h2">Utilization Pattern & Coverage</div>

      </div>

      <div class="two-col">
        <div class="chart-card" style="min-height:250px;">
          <div class="chart-title">
            <div class="t">Encounter Utilization Trend</div>
            <div class="tag" id="aggTag">Encounters per month</div>
          </div>
          <div class="chart-body">
            <canvas id="utilMonthlyChart"></canvas>
          </div>
        </div>

        <div class="chart-card" style="min-height:250px;">
          <div class="chart-title">
            <div class="t">Encounter Type Distribution</div>
            <div class="tag">AMB / ER / IP</div>
          </div>
          <div class="chart-body">
            <canvas id="encounterClassChart"></canvas>
          </div>
        </div>
      </div>

      <div class="mini" style="margin-top:14px;">
        <div class="box">
          <div class="k">Coverage</div>
          <div class="v" id="kpiCoverage">—</div>
          <div class="d">Claim / EOB 保險型態</div>
        </div>
        <div class="box">
          <div class="k">$0 Payments</div>
          <div class="v" id="kpiZeroPay">—</div>
          <div class="d">未實際給付之 EOB</div>
        </div>
      </div>
    </div>

    <div class="panel" style="margin-top:14px;">
      <div class="section-head">
        <div class="h2">Benefits (EOB) & Preventive Care</div>
        <div class="hint">EOB 摘要列表 + 疫苗事件</div>
      </div>

      <div class="list">
        <div class="chart-card" style="min-height:450px; margin-bottom:12px;">
          <div class="chart-title"><div class="t">ExplanationOfBenefit List</div></div>
          <div class="chart-body" id="eobList" style="overflow-y:auto; max-height:500px;">
            <div class="item">正在讀取 ExplanationOfBenefit...</div>
          </div>
        </div>

        <div class="chart-card" style="min-height:450px;">
          <div class="chart-title"><div class="t">Immunization Timeline</div></div>
          <div class="chart-body" id="immList" style="overflow-y:auto; max-height:500px;">
            <div class="item">正在讀取 Immunization...</div>
          </div>
        </div>
      </div>

      <div class="list" style="margin-top:12px;">
        <div class="item" id="orgCard">
          <div class="title">Primary Organization</div>
          <div class="meta" id="orgMeta">—</div>
        </div>
        <div class="item" id="pracCard">
          <div class="title">Primary Practitioner</div>
          <div class="meta" id="pracMeta">—</div>
        </div>
      </div>

      <pre id="debug" style="display:none; background:#f1f5f9; padding:10px; font-size:12px;"></pre>
    </div>

    <div class="footer">
      <div>Page 5 · Utilization & Coverage</div>
      <div class="footer-muted">資料來源：Encounter / Claim / EOB / Immunization</div>
    </div>
  </div>

<script>
  const DateTime = luxon.DateTime;
  let __smartResolved = false;

  const __setStatus = (level, text) => {
    const st = document.getElementById("statusText");
    const pill = document.getElementById("statusPill");
    const pillText = document.getElementById("statusPillText");
    if(st) st.textContent = text || "";
    if(pillText) pillText.textContent = text || "";
    if(pill){
      pill.classList.remove("ok","warn","bad");
      pill.classList.add(level || "warn");
    }
  };

  function escapeHtml(s) {
    return String(s ?? "").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }

  function fmtDate(iso){
    if(!iso) return "—";
    const dt = DateTime.fromISO(iso);
    return dt.isValid ? dt.toFormat("yyyy-LL-dd") : iso;
  }

  function fmtDateTime(iso){
    if(!iso) return "—";
    const dt = DateTime.fromISO(iso);
    return dt.isValid ? dt.toFormat("yyyy-LL-dd HH:mm") : iso;
  }



  function safeGet(obj, path, fallback=null){
    try{
      return path.split(".").reduce((acc, k) => (acc && acc[k] !== undefined) ? acc[k] : undefined, obj) ?? fallback;
    }catch(e){ return fallback; }
  }

  function uniq(arr){ return Array.from(new Set(arr.filter(Boolean))); }

  function asMoney(v, cur){
    const n = Number(v);
    return isNaN(n) ? String(v) : `${n.toFixed(2)} ${cur || ""}`.trim();
  }

  function codeDisplay(cc){
    if(!cc) return "—";
    return cc.text || (cc.coding && cc.coding[0]?.display) || (cc.coding && cc.coding[0]?.code) || "—";
  }

  function returnToSelect() {
    sessionStorage.removeItem("selected_patient_id");
    window.location.href = "patient-select.html";
  }

  async function requestAll(client, initialUrl, maxPages=10){
    const out = [];
    let url = initialUrl;
    for(let i=0; i<maxPages; i++){
      const bundle = await client.request(url);
      (bundle.entry || []).forEach(e => { if(e.resource) out.push(e.resource); });
      const next = (bundle.link || []).find(l => l.relation === "next");
      if(!next || !next.url) break;
      url = next.url;
    }
    return out;
  }

  let chart2 = null, chartClass = null;

  FHIR.oauth2.ready().then(async (client) => {
    __smartResolved = true;
    let patientId = sessionStorage.getItem("selected_patient_id") || client.patient.id;
    if (!patientId) throw new Error("找不到病患 ID");

    const patient = await client.request(`Patient/${patientId}`);
    const name = patient.name
        ? (patient.name[0].text || (patient.name[0].prefix + " " + patient.name[0].family + " " +
        " " + (patient.name[0].given ? patient.name[0].given.join(" ") : "")))
        : "未知姓名";
    document.getElementById("pName").textContent = name;
    document.getElementById("pId").textContent = patient.id;
    if(document.getElementById("pId_dup")) document.getElementById("pId_dup").textContent = patient.id;
    document.getElementById("pGender").textContent = patient.gender || "—";
    document.getElementById("pBirth").textContent = fmtDate(patient.birthDate);

    const [encs, claims, eobs, imms] = await Promise.all([
      requestAll(client, `Encounter?patient=${patientId}&_count=100`),
      requestAll(client, `Claim?patient=${patientId}&_count=100`),
      requestAll(client, `ExplanationOfBenefit?patient=${patientId}&_count=100`),
      requestAll(client, `Immunization?patient=${patientId}&_count=100`)
    ]);

    document.getElementById("kpiEnc").textContent = encs.length;
    document.getElementById("kpiClaim").textContent = claims.length;
    document.getElementById("kpiEob").textContent = eobs.length;

    // KPI: Providers
    const provs = uniq([...encs.map(e=>e.serviceProvider?.reference), ...claims.map(c=>c.provider?.reference)]);
    document.getElementById("kpiProv").textContent = provs.length;

    // KPI: Last date
    const dates = encs.map(e => e.period?.start).filter(Boolean).sort();
    document.getElementById("kpiLast").textContent = dates.length ? fmtDate(dates[dates.length-1]) : "—";

    // KPI: Zero Pay
    const zeroPay = eobs.filter(e => safeGet(e, "payment.amount.value") === 0).length;
    document.getElementById("kpiZeroPay").textContent = zeroPay;

    buildMonthlyHistogram(encs);
    buildEncounterClassChart(encs);
    renderEobList(eobs, claims);
    renderImmunizationList(imms, claims);

    __setStatus("ok", "資料載入完成");
  }).catch(err => {
    __setStatus("bad", "錯誤: " + err.message);
    console.error(err);
  });

  function buildMonthlyHistogram(encs){
    const buckets = {};
    encs.forEach(e => {
      const d = e.period?.start;
      if(!d) return;
      const key = d.substring(0, 7);
      buckets[key] = (buckets[key] || 0) + 1;
    });
    const labels = Object.keys(buckets).sort();
    const values = labels.map(l => buckets[l]);
    new Chart(document.getElementById("utilMonthlyChart"), {
      type: 'bar',
      data: { labels, datasets: [{ label: '就醫次數', data: values, backgroundColor: '#3b82f6' }] },
      options: { maintainAspectRatio: false }
    });
  }

  function buildEncounterClassChart(encs){
    const counts = {};
    encs.forEach(e => {
      const c = e.class?.code || 'UNK';
      counts[c] = (counts[c] || 0) + 1;
    });
    new Chart(document.getElementById("encounterClassChart"), {
      type: 'pie',
      data: { 
        labels: Object.keys(counts), 
        datasets: [{ data: Object.values(counts), backgroundColor: ['#3b82f6','#10b981','#f59e0b','#ef4444'] }] 
      },
      options: { maintainAspectRatio: false }
    });
  }

  function renderEobList(eobs, claims){
    const host = document.getElementById("eobList");
    host.innerHTML = "";
    if(!eobs.length) { host.innerHTML = "無資料"; return; }

    eobs.forEach(eob => {
      const payV = safeGet(eob, "payment.amount.value");
      const statusClass = (payV > 0) ? "ok" : (payV === 0 ? "bad" : "warn");
      const div = document.createElement("div");
      div.className = "item";
      div.innerHTML = `
        <div class="title">EOB / ${eob.id}</div>
        <div class="meta">日期: ${fmtDate(eob.created)}</div>
        <div class="status-pill ${statusClass}"><div class="dot"></div><div>Payment: ${asMoney(payV, safeGet(eob,"payment.amount.currency"))}</div></div>
        <details class="more"><summary>Raw JSON</summary><div class="kv">${escapeHtml(JSON.stringify(eob, null, 2))}</div></details>
      `;
      host.appendChild(div);
    });
  }

  function renderImmunizationList(imms, claims){
    const host = document.getElementById("immList");
    host.innerHTML = "";
    if(!imms.length) { host.innerHTML = "無資料"; return; }

    imms.forEach(imm => {
      const div = document.createElement("div");
      div.className = "item";
      div.innerHTML = `
        <div class="title">${codeDisplay(imm.vaccineCode)}</div>
        <div class="meta">施打日期: ${fmtDateTime(imm.occurrenceDateTime)}</div>
        <details class="more"><summary>Raw JSON</summary><div class="kv">${escapeHtml(JSON.stringify(imm, null, 2))}</div></details>
      `;
      host.appendChild(div);
    });
  }
</script>
</body>
</html>
