<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <!-- UTF-8：避免中文亂碼 -->
  <meta charset="UTF-8" />
  <!-- RWD -->
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Patient Health Dashboard (CarePlan)</title>

  <!-- SMART on FHIR SDK：OAuth ready + client.request -->
  <script src="https://cdn.jsdelivr.net/npm/fhirclient/build/fhir-client.js"></script>

  <!-- Luxon：日期格式化 / 排序 -->
  <script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>

  <!-- 統一 theme（和其他頁一致） -->
  <link rel="stylesheet" href="css/theme.css">
</head>

<body>
  <div class="page">
    <!-- Topbar：品牌 + 分頁 + 病患 ID + 重新選擇 -->
    <div class="topbar">
      <div class="brand">
        <div class="brand-badge">PH</div>
        <div class="brand-title">
          <div class="t1">SMART on FHIR</div>
          <div class="t2">Patient Health Dashboard</div>
        </div>
      </div>

      <div class="tabs" role="navigation" aria-label="Pages">
        <a class="tab" href="overview.html">Overview</a>
        <a class="tab" href="timeline.html">Timeline</a>
        <a class="tab" href="labs.html">Labs & Reports</a>
        <a class="tab active" href="careplan.html">CarePlan</a>
        <a class="tab" href="utilization.html">Utilization</a>
      </div>

      <div class="top-actions">
        <div class="pill" title="目前病人資訊（由 FHIR 載入）">
          <span class="dot"></span>
          <span style="color:var(--muted)">ID:</span>
          <!-- ✅ 避免跟 banner 重複 id -->
          <code id="pIdTop">—</code>
        </div>
        <button class="btn" onclick="returnToSelect()">重新選擇病人</button>
      </div>
    </div>

    <h1>CarePlan</h1>
    <p id="loadHint" style="color:var(--muted); font-weight:800">照護計畫</p>

    <!-- Patient banner：顯示目前病人基本資料 -->
    <div class="patient-card">
      <div class="patient-block">
        <div class="name" id="pName">正在讀取...</div>
        <div class="meta">
          ID: <span id="pId_dup">—</span>
          ｜ 性別: <span id="pGender">—</span>
          ｜ 生日: <span id="pBirth">—</span>
        </div>
      </div>
    </div>
    <!-- ✅ 補齊 patient-card 結構 -->

    <!-- Summary cards：快速掌握 CarePlan 數量與狀態分佈 -->
    <div class="summary-grid" aria-label="CarePlan summary">
      <div class="card"><div class="k">全部計畫</div><div id="sumTotal" class="v">—</div><div class="d">Total CarePlans</div></div>
      <div class="card"><div class="k">進行中</div><div id="sumActive" class="v">—</div><div class="d">Active</div></div>
      <div class="card"><div class="k">已完成</div><div id="sumCompleted" class="v">—</div><div class="d">Completed</div></div>
      <div class="card"><div class="k">已取消</div><div id="sumCancelled" class="v">—</div><div class="d">Cancelled</div></div>
      <div class="card"><div class="k">活動總數</div><div id="sumActivities" class="v">—</div><div class="d">Activities count</div></div>
    </div>

    <!-- Main content：左列表 / 右詳情 -->
    <div class="charts-wrap">
      <div class="section-head">
        <div class="h2">Plans</div>
      </div>

      <div class="content-grid">
        <!-- 左側：CarePlan 清單 -->
        <div class="panel-card">
          <div class="panel-title">
            <div class="t">CarePlan 清單 <span class="tag" id="listTag">—</span></div>
            <div style="display:flex;gap:10px;flex-wrap:wrap">
              <!-- 篩選：全部 / active / completed / cancelled -->
              <button class="btn secondary" id="btnFilter" title="切換：全部/進行中/已完成/已取消">篩選：全部</button>
              <!-- 排序：依期間或更新時間 -->
              <button class="btn secondary" id="btnSort" title="切換排序：期間/更新">排序：期間新→舊</button>
            </div>
          </div>
          <div class="panel-body" id="list">
            <div class="empty">尚未載入 CarePlan。</div>
          </div>
        </div>

        <!-- 右側：CarePlan 詳情（選到左邊某筆才顯示） -->
        <div class="panel-card">
          <div class="panel-title">
            <div class="t">CarePlan 詳情 <span class="tag" id="detailTag">—</span></div>
            <div style="display:flex;gap:10px;flex-wrap:wrap">
              <!-- Debug 開關：顯示 raw JSON / reference 查詢 -->
              <button class="btn secondary" id="btnToggleDebug">Debug：關閉</button>
            </div>
          </div>
          <div class="panel-body" id="detail">
            <div class="empty">請從左側選一筆 CarePlan。</div>
          </div>
        </div>
      </div>

      <!-- Debug 區：預設關閉 -->
      <pre id="debug" style="display:none"></pre>
    </div>

    <div class="footer">
      <span>© Patient Health</span>
    </div>
  </div>

<script>
  // =========================
  // 導頁：回到病患選擇頁
  // =========================
  function returnToSelect() {
    sessionStorage.removeItem("selected_patient_id");
    window.location.href = "patient-select.html";
  }

  // =========================
  // helpers：日期 / 狀態字串 / 安全處理
  // =========================
  const DateTime = luxon.DateTime;

  function fmtISO(d){
    // 將 ISO 字串格式化成 yyyy-mm-dd
    if(!d) return "—";
    try{
      const dt = DateTime.fromISO(d);
      if(!dt.isValid) return d;
      return dt.toFormat("yyyy-LL-dd");
    }catch{ return d; }
  }

  // CarePlan.status → 中文（臨床/使用者友善）
  function statusZh(s){
    const m = {
      "active":"進行中",
      "completed":"已完成",
      "cancelled":"已取消",
      "draft":"草稿",
      "entered-in-error":"輸入錯誤"
    };
    return m[s] || (s || "—");
  }

  // CarePlan.intent → 中文解釋（更像臨床語境）
  function intentZh(i){
    const m = { "order":"醫囑/處置計畫", "plan":"計畫", "proposal":"建議", "option":"選項" };
    return m[i] || (i || "—");
  }

  // UI tone：依狀態呈現不同顏色（完成=ok、進行中=warn、取消=bad）
  function toneClass(status){
    if(status==="completed") return "ok";
    if(status==="active") return "warn";
    if(status==="cancelled" || status==="entered-in-error") return "bad";
    return "";
  }

  function codingText(c){
    // 把 coding 的 display + code 組合成可讀文字
    const cc = c?.[0];
    if(!cc) return "";
    const disp = cc.display || "";
    const code = cc.code ? `SNOMED: ${cc.code}` : "";
    return (disp && code) ? `${disp}（${code}）` : (disp || code);
  }

  function stripTags(html){
    // 去掉 narrative 的 HTML tag，只取文字
    if(!html) return "";
    const tmp = document.createElement("div");
    tmp.innerHTML = String(html);
    return (tmp.textContent || tmp.innerText || "").trim();
  }

  // narrative 白名單：避免 CP.text.div 帶來不安全的 HTML
  function sanitizeNarrative(html){
    if(!html) return "";
    const allowed = new Set(["BR","P","DIV","UL","OL","LI","B","STRONG","I","EM","SPAN"]);
    const tmp = document.createElement("div");
    tmp.innerHTML = String(html);

    const walk = (node) => {
      for(const ch of Array.from(node.childNodes)){
        if(ch.nodeType === Node.ELEMENT_NODE){
          if(!allowed.has(ch.tagName)){
            ch.replaceWith(document.createTextNode(ch.textContent || ""));
            continue;
          }
          // 移除所有 attribute（避免 style / onclick 等）
          for(const a of Array.from(ch.attributes)) ch.removeAttribute(a.name);
          walk(ch);
        }else if(ch.nodeType === Node.COMMENT_NODE){
          ch.remove();
        }
      }
    };
    walk(tmp);
    return tmp.innerHTML;
  }

  // 取 CarePlan 顯示標題：先用 category/text，再用 narrative，再用 id
  function pickTitle(cp){
    const cat = cp?.category?.[0];
    const t = cat?.text || cat?.coding?.[0]?.display;
    if(t) return t;
    const n = stripTags(cp?.text?.div || "");
    if(n) return n.split("\n")[0].slice(0,80);
    return `CarePlan/${cp?.id || "—"}`;
  }

  // =========================
  // state：資料與 UI 狀態
  // =========================
  let carePlans = [];
  let selectedId = null;

  // 列表篩選/排序狀態
  let filterMode = "all";       // all | active | completed | cancelled
  let sortMode = "periodDesc";  // periodDesc | updatedDesc

  // 套用篩選+排序
  function applyFilterSort(list){
    let out = list.slice();

    if(filterMode !== "all"){
      out = out.filter(cp => (cp.status || "") === filterMode);
    }

    const periodKey = (cp) => {
      const s = cp?.period?.start ? DateTime.fromISO(cp.period.start).toMillis() : 0;
      const e = cp?.period?.end ? DateTime.fromISO(cp.period.end).toMillis() : 0;
      return e || s || 0;
    };
    const updKey = (cp) => cp?.meta?.lastUpdated ? DateTime.fromISO(cp.meta.lastUpdated).toMillis() : 0;

    out.sort((a,b)=>{
      if(sortMode === "updatedDesc") return updKey(b) - updKey(a);
      return periodKey(b) - periodKey(a);
    });

    return out;
  }

  // Summary 卡片：統計狀態與 activity 總數
  function setSummary(list){
    const total = list.length;
    const active = list.filter(x => x.status === "active").length;
    const completed = list.filter(x => x.status === "completed").length;
    const cancelled = list.filter(x => x.status === "cancelled").length;
    const activities = list.reduce((acc, cp) => acc + ((cp.activity || []).length), 0);

    document.getElementById("sumTotal").textContent = total;
    document.getElementById("sumActive").textContent = active;
    document.getElementById("sumCompleted").textContent = completed;
    document.getElementById("sumCancelled").textContent = cancelled;
    document.getElementById("sumActivities").textContent = activities;

    const shown = applyFilterSort(list).length;
    document.getElementById("listTag").textContent = `${shown} 筆`;
  }

  // 左側列表渲染：可點選某筆 CarePlan
  function renderList(){
    const host = document.getElementById("list");
    const shown = applyFilterSort(carePlans);

    document.getElementById("listTag").textContent = `${shown.length} 筆`;

    if(!shown.length){
      host.innerHTML = `<div class="empty">目前沒有符合條件的 CarePlan。</div>`;
      return;
    }

    host.innerHTML = shown.map(cp => {
      const title = pickTitle(cp);
      const status = cp.status || "—";
      const tone = toneClass(status);
      const period = `${fmtISO(cp?.period?.start)} – ${fmtISO(cp?.period?.end)}`;
      const intent = intentZh(cp.intent);
      const actCount = (cp.activity || []).length;
      const addrCount = (cp.addresses || []).length;
      const updated = cp?.meta?.lastUpdated ? fmtISO(cp.meta.lastUpdated) : "—";

      const isActive = (cp.id === selectedId);

      return `
        <div class="cp-item ${isActive ? "active" : ""}" role="button" tabindex="0" onclick="selectPlan('${cp.id}')">
          <div class="cp-top">
            <div>
              <div class="cp-title">${escapeHtml(title)}</div>
              <div class="cp-sub">
                <b>${escapeHtml(statusZh(status))}</b> ・ ${escapeHtml(intent)}<br/>
                期間：${escapeHtml(period)} ｜ 更新：${escapeHtml(updated)}
              </div>
            </div>
            <div class="chip ${tone}">
              <span class="dot"></span>${escapeHtml(statusZh(status))}
            </div>
          </div>
          <div class="chiprow">
            <div class="chip"><span class="dot"></span>活動：${actCount} 項</div>
            <div class="chip"><span class="dot"></span>關聯問題：${addrCount} 個</div>
            <div class="chip"><span class="dot"></span>ID：<span class="mono">${escapeHtml(cp.id || "—")}</span></div>
          </div>
        </div>
      `;
    }).join("");
  }

  // 右側詳情：活動清單 + narrative + 系統資訊 + 參照資源按鈕
  function renderDetail(){
    const host = document.getElementById("detail");
    const cp = carePlans.find(x => x.id === selectedId);

    if(!cp){
      document.getElementById("detailTag").textContent = "—";
      host.innerHTML = `<div class="empty">請從左側選一筆 CarePlan。</div>`;
      return;
    }

    document.getElementById("detailTag").textContent = statusZh(cp.status || "");

    const title = pickTitle(cp);
    const status = cp.status || "—";
    const intent = intentZh(cp.intent);
    const period = `${fmtISO(cp?.period?.start)} – ${fmtISO(cp?.period?.end)}`;
    const catCoding = cp?.category?.[0]?.coding || [];
    const catText = codingText(catCoding);

    const subjRef = cp?.subject?.reference || "";
    const encRef = cp?.encounter?.reference || "";
    const addrRefs = (cp?.addresses || []).map(a => a.reference).filter(Boolean);

    // activity：通常是照護介入項目（例如復健、衛教、追蹤）
    const activities = (cp?.activity || []).map((a, idx) => {
      const d = a?.detail || {};
      const aStatus = d.status || "—";
      const done = aStatus === "completed";
      const main = d?.code?.text || d?.code?.coding?.[0]?.display || `Activity #${idx+1}`;
      const code = d?.code?.coding?.[0]?.code || "";
      const codeDisp = d?.code?.coding?.[0]?.display || "";
      return { done, aStatus, main, code, codeDisp, raw: a };
    });

    const narrativeSafe = sanitizeNarrative(cp?.text?.div || "");

    host.innerHTML = `
      <div class="hero">
        <h3>${escapeHtml(title)} <span class="muted">（照護計畫）</span></h3>
        <div class="subline">
          <span>狀態：<b>${escapeHtml(statusZh(status))}</b></span>
          <span>意圖：<b>${escapeHtml(intent)}</b></span>
          <span>期間：<b>${escapeHtml(period)}</b></span>
          ${catText ? `<span>代碼：<b>${escapeHtml(catText)}</b></span>` : ``}
        </div>
        <div class="subline" style="margin-top:10px">
          ${subjRef ? `<button class="linkbtn" onclick="openRef('${escapeAttr(subjRef)}')">病患 <code>${escapeHtml(subjRef)}</code></button>` : ``}
          ${encRef ? `<button class="linkbtn" onclick="openRef('${escapeAttr(encRef)}')">就醫事件 <code>${escapeHtml(encRef)}</code></button>` : ``}
          ${addrRefs.map(r => `<button class="linkbtn" onclick="openRef('${escapeAttr(r)}')">關聯問題 <code>${escapeHtml(r)}</code></button>`).join("")}
        </div>
      </div>

      <div class="block">
        <div class="bh">
          <div class="t">活動清單（介入項目）</div>
          <div class="muted">${activities.length} 項</div>
        </div>
        <div class="bb">
          ${activities.length ? activities.map(a => `
            <div class="check">
              <div class="mark ${a.done ? "" : "pending"}">${a.done ? "✓" : "•"}</div>
              <div style="min-width:0">
                <div class="main">${escapeHtml(a.main)}</div>
                <div class="sub">${escapeHtml(statusZh(a.aStatus))}${a.code ? ` ・ ${escapeHtml(a.codeDisp || "")}（SNOMED: ${escapeHtml(a.code)}）` : ""}</div>
                <details>
                  <pre>${escapeHtml(JSON.stringify(a.raw, null, 2))}</pre>
                </details>
              </div>
            </div>
          `).join("") : `<div class="empty">此 CarePlan 沒有 activity。</div>`}
        </div>
      </div>

      <div class="block">
        <div class="bh">
          <div class="t">文字敘述（Narrative）</div>
        </div>
        <div class="bb">
          ${narrativeSafe ? `<div style="line-height:1.55">${narrativeSafe}</div>` : `<div class="empty">此 CarePlan 沒有 text.div。</div>`}
        </div>
      </div>

      <div class="block">
        <div class="bh">
          <div class="t">系統資訊</div>
          <div class="muted">lastUpdated / tags / references</div>
        </div>
        <div class="bb">
          <details>
            <summary>詳細資訊</summary>
            <pre>${escapeHtml(JSON.stringify({
              id: cp.id,
              status: cp.status,
              intent: cp.intent,
              period: cp.period || null,
              subject: subjRef || null,
              encounter: encRef || null,
              addresses: addrRefs,
              meta: cp.meta || null,
              category: cp.category || null
            }, null, 2))}</pre>
          </details>
        </div>
      </div>
    `;

    // 如果 debug 開啟，更新 debug JSON
    const dbg = document.getElementById("debug");
    if(dbg && dbg.style.display !== "none"){
      dbg.textContent = JSON.stringify(cp, null, 2);
    }
  }

  // 讓 inline onclick 可以呼叫
  window.selectPlan = function(id){
    selectedId = id;
    renderList();
    renderDetail();
  }

  // 週期切換：篩選模式
  function cycleFilter(){
    const order = ["all","active","completed","cancelled"];
    const idx = order.indexOf(filterMode);
    filterMode = order[(idx+1) % order.length];

    const label = filterMode==="all" ? "全部"
      : filterMode==="active" ? "進行中"
      : filterMode==="completed" ? "已完成"
      : "已取消";

    document.getElementById("btnFilter").textContent = "篩選：" + label;

    renderList();

    // 如果目前 selectedId 被篩掉，改選第一筆
    const shown = applyFilterSort(carePlans);
    if(selectedId && !shown.find(x => x.id === selectedId)){
      selectedId = shown[0]?.id || null;
      renderList();
      renderDetail();
    }
    document.getElementById("listTag").textContent = `${applyFilterSort(carePlans).length} 筆`;
  }

  // 週期切換：排序模式
  function cycleSort(){
    sortMode = (sortMode === "periodDesc") ? "updatedDesc" : "periodDesc";
    document.getElementById("btnSort").textContent =
      (sortMode==="periodDesc") ? "排序：期間新→舊" : "排序：更新新→舊";
    renderList();
  }

  document.getElementById("btnFilter").addEventListener("click", cycleFilter);
  document.getElementById("btnSort").addEventListener("click", cycleSort);

  // Debug 開關
  document.getElementById("btnToggleDebug").addEventListener("click", ()=>{
    const dbg = document.getElementById("debug");
    const on = dbg.style.display !== "none";
    dbg.style.display = on ? "none" : "block";
    document.getElementById("btnToggleDebug").textContent = on ? "Debug：關閉" : "Debug：開啟";
    if(!on){
      const cp = carePlans.find(x => x.id === selectedId);
      dbg.textContent = cp ? JSON.stringify(cp, null, 2) : "";
    }
  });

  // HTML escape：避免插入字串造成 XSS
  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }
  function escapeAttr(s){ return escapeHtml(s); }

  // 點 reference：用 debug 區顯示 raw resource（對 demo/評審很有說服力）
  async function openRef(ref){
    try{
      const dbg = document.getElementById("debug");
      dbg.style.display = "block";
      document.getElementById("btnToggleDebug").textContent = "Debug：開啟";

      dbg.textContent = `Loading ${ref}...`;
      const res = await window._client.request(ref);
      dbg.textContent = JSON.stringify(res, null, 2);
      dbg.scrollIntoView({behavior:"smooth", block:"nearest"});
    }catch(err){
      const dbg = document.getElementById("debug");
      dbg.style.display = "block";
      dbg.textContent = `讀取 ${ref} 失敗：\n` + String(err?.message || err);
    }
  }
  window.openRef = openRef;

  // 抓 CarePlan：不同伺服器可能用 subject 或 patient
  async function loadCarePlans(client, patientId){
    const queries = [
      `CarePlan?subject=Patient/${patientId}&_count=200`,
      `CarePlan?patient=${patientId}&_count=200`
    ];

    for(const q of queries){
      try{
        const bundle = await client.request(q);
        const cps = (bundle.entry || [])
          .map(e => e.resource)
          .filter(r => r?.resourceType === "CarePlan");
        if(cps.length) return cps;
      }catch(_e){ /* try next */ }
    }
    return [];
  }

  // =========================
  // 主流程：OAuth ready → patient → careplans → render
  // =========================
  FHIR.oauth2.ready().then(async (client) => {
    // 1) patientId：優先從 patient-select.html 的 sessionStorage 拿
    let patientId = sessionStorage.getItem("selected_patient_id");
    if(!patientId && client.patient && client.patient.id) patientId = client.patient.id;
    if(!patientId) throw new Error("找不到病患 ID，請先重新選擇病人。");

    // 讓 openRef 能用同一個 client
    window._client = client;

    // 2) 病人基本資料
    const patient = await client.request(`Patient/${patientId}`);
    const name = patient.name
      ? (patient.name[0].text || `${patient.name[0].prefix || ''} ${patient.name[0].family || ''} ${patient.name[0].given ? patient.name[0].given.join(" ") : ''}`.trim())
      : "未知姓名";

    document.getElementById("pName").textContent = name;
    document.getElementById("pIdTop").textContent = patientId;
    document.getElementById("pId_dup").textContent = patientId;
    document.getElementById("pGender").textContent = patient.gender ?? "未知";
    document.getElementById("pBirth").textContent = patient.birthDate ?? "未知";

    // 3) 讀取 CarePlan
    carePlans = await loadCarePlans(client, patientId);

    // 4) summary + empty state
    setSummary(carePlans);

    if(!carePlans.length){
      document.getElementById("list").innerHTML = `<div class="empty">此病人目前沒有 CarePlan。</div>`;
      document.getElementById("detail").innerHTML = `<div class="empty">沒有可顯示的 CarePlan。</div>`;
      document.getElementById("listTag").textContent = "0 筆";
      return;
    }

    // 5) 選第一筆（依目前 filter/sort）
    const shown = applyFilterSort(carePlans);
    selectedId = shown[0]?.id || carePlans[0].id;

    renderList();
    renderDetail();

  }).catch(err => {
    console.error(err);
    setText("pName", "請由 launch.html 啟動或點擊按鈕重新選擇。" + (err?.message ? " " + err.message : ""));
    setText("loadHint", "SMART session 未就緒" + (err?.message ? " " + err.message : ""));
    showDebug(String(err));
  });
</script>
</body>
</html>
