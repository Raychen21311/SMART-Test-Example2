<!DOCTYPE html>
<html>
<head>
  <!-- ä½¿ç”¨ UTF-8 -->
  <meta charset="UTF-8" />

  <!-- é é¢æ¨™é¡Œï¼šç—…æ‚£é¸æ“‡é  -->
  <title>é¸æ“‡ç—…æ‚£ - Patient Selector</title>

  <!-- SMART on FHIR JavaScript SDK
       ç”¨ä¾†æ¥ OAuth tokenã€å‘¼å« FHIR API -->
  <script src="https://cdn.jsdelivr.net/npm/fhirclient/build/fhir-client.js"></script>

  <!--
    ç°¡å–® UI æ¨£å¼
    è¨­è¨ˆé‡é»ï¼š
    - å¡ç‰‡å¼ï¼ˆcard-basedï¼‰
    - å¼·èª¿ã€Œè³‡æ–™è±å¯Œåº¦ã€è€Œä¸æ˜¯åªæœ‰ç—…æ‚£åŸºæœ¬è³‡æ–™
  -->
  <style>
    :root {
      --bg: #f6f7fb;
      --brand: #3b82f6;
      --card: #ffffff;
      --text: #1f2937;
    }

    body {
      font-family: system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      padding: 40px 20px;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
    }

    h1 {
      text-align: center;
      font-weight: 900;
      margin-bottom: 30px;
    }

    /* é€£ç·šèˆ‡åˆ†æä¸­çš„ç‹€æ…‹æç¤º */
    .loading {
      text-align: center;
      font-weight: 700;
      color: var(--brand);
    }

    /* ç—…æ‚£æ¸…å–®ä½¿ç”¨ grid æ’åˆ— */
    .patient-list {
      display: grid;
      gap: 15px;
    }

    /* å–®ä¸€ç—…æ‚£å¡ç‰‡ */
    .patient-item {
      background: var(--card);
      padding: 20px;
      border-radius: 16px;
      border: 1px solid rgba(0,0,0,0.05);
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      transition: transform 0.2s, border-color 0.2s;
    }

    /* hover æç¤ºã€Œå¯é»é¸ã€ */
    .patient-item:hover {
      transform: translateY(-2px);
      border-color: var(--brand);
    }

    .info .name {
      font-size: 18px;
      font-weight: 800;
      color: var(--brand);
    }

    .info .meta {
      font-size: 14px;
      color: #6b7280;
      margin-top: 4px;
    }

    /* å³å´è³‡æ–™é‡å¾½ç«  */
    .data-badge {
      background: #eff6ff;
      color: var(--brand);
      padding: 8px 16px;
      border-radius: 999px;
      font-size: 13px;
      font-weight: 900;
      border: 1px solid #dbeafe;
    }

    /* è³‡æ–™é‡å¤šçš„ç—…æ‚£ï¼Œè¦–è¦ºä¸Šç‰¹åˆ¥æ¨™ç¤º */
    .rich-data {
      background: #dcfce7;
      color: #16a34a;
      border-color: #bbf7d0;
    }
  </style>
</head>

<body>

<div class="container">
  <h1>é¸æ“‡æ¸¬è©¦ç—…æ‚£</h1>

  <!-- åˆå§‹ç‹€æ…‹ï¼šé¡¯ç¤ºé€£ç·šèˆ‡åˆ†æä¸­ -->
  <div id="status" class="loading">
    æ­£åœ¨é€£ç·šè‡³ FHIR ä¼ºæœå™¨ä¸¦åˆ†æç—…æ‚£è³‡æ–™é‡...
  </div>

  <!-- ç—…æ‚£å¡ç‰‡å‹•æ…‹æ’å…¥çš„ä½ç½® -->
  <div id="patientList" class="patient-list"></div>
</div>

<script>
  /*
    OAuth å·²å®Œæˆå¾Œï¼ŒFHIR.oauth2.ready() æ‰æœƒé€²ä¾†
    client å…§å·²åŒ…å« access token èˆ‡ server è¨­å®š
  */
  FHIR.oauth2.ready().then(async (client) => {
    try {

      // ================================
      // 1ï¸âƒ£ å–å¾—ç—…æ‚£æ¸…å–®
      // ================================
      // é€™è£¡åªæŠ“å‰ 20 ä½æ¸¬è©¦ç—…æ‚£ï¼ˆDemo ç”¨ï¼‰
      const bundle = await client.request("Patient?_count=20");
      const patients = bundle.entry || [];

      const listContainer = document.getElementById("patientList");
      document.getElementById("status").style.display = "none";

      // ================================
      // 2ï¸âƒ£ å®šç¾©ã€Œè³‡æ–™è±å¯Œåº¦æª¢æŸ¥æ¸…å–®ã€
      // ================================
      // é€™äº›è³‡æº = overview / index é é¢æœƒç”¨åˆ°çš„è³‡æ–™
      const checkList = [
        { key: 'vitals',      label: 'ç”Ÿå‘½å¾µè±¡',   query: 'Observation?category=vital-signs' },
        { key: 'labs',        label: 'å¯¦é©—å®¤å ±å‘Š', query: 'Observation?category=laboratory' },
        { key: 'timeline',    label: 'è¨ºæ–·',       query: 'Condition' },
        { key: 'careplan',    label: 'ç…§è­·è¨ˆç•«',   query: 'CarePlan' },
        { key: 'utilization', label: 'å°±é†«ç´€éŒ„',   query: 'Encounter' }
      ];

      // ================================
      // 3ï¸âƒ£ é€ä¸€è™•ç†ç—…æ‚£
      // ================================
      for (const entry of patients) {
        const p = entry.resource;
        const id = p.id;

        // ç—…æ‚£å§“åè™•ç†ï¼š
        // å„ªå…ˆä½¿ç”¨ name.textï¼Œå¦å‰‡è‡ªå·±çµ„ prefix / family / given
        let name = "æœªçŸ¥å§“å";
        if (p.name && p.name[0]) {
          const n = p.name[0];
          name = n.text || `${n.prefix || ''} ${n.family || ''} ${n.given ? n.given.join(" ") : ''}`.trim();
        }

        // ================================
        // 4ï¸âƒ£ å¹³è¡ŒæŸ¥è©¢å„é …è³‡æºæ•¸é‡
        // ================================
        // ä½¿ç”¨ _summary=count â†’ åªæ‹¿æ•¸é‡ï¼Œä¸æ‹¿å¯¦é«”è³‡æ–™ï¼Œé€Ÿåº¦å¿«å¾ˆå¤š
        const results = await Promise.all(
          checkList.map(item =>
            client.request(`${item.query}&patient=${id}&_summary=count`)
              .catch(() => ({ total: 0 })) // ä»»ä¸€å¤±æ•—å°±ç•¶ä½œ 0
          )
        );

        // ================================
        // 5ï¸âƒ£ å½™æ•´è³‡æ–™é‡èˆ‡æ¨™ç±¤
        // ================================
        let totalDataCount = 0;
        let activeTags = [];

        results.forEach((res, index) => {
          const count = res.total || 0;
          if (count > 0) {
            totalDataCount += count;
            activeTags.push(checkList[index].label);
          }
        });

        // ğŸ”¥ æ ¸å¿ƒè¨­è¨ˆé‚è¼¯ï¼š
        // å®Œå…¨æ²’æœ‰è‡¨åºŠè³‡æ–™çš„ç—…æ‚£ã€Œä¸é¡¯ç¤ºã€
        if (totalDataCount === 0) continue;

        // ================================
        // 6ï¸âƒ£ å»ºç«‹ç—…æ‚£å¡ç‰‡ UI
        // ================================
        const item = document.createElement("div");
        item.className = "patient-item";

        // è³‡æ–™é¡å‹æ¨™ç±¤ï¼ˆè¨ºæ–· / æª¢é©— / å°±é†«ç­‰ï¼‰
        const tagsHtml = activeTags.map(tag =>
          `<span style="
            font-size:11px;
            background:#e0f2fe;
            color:#0369a1;
            padding:2px 8px;
            border-radius:4px;
            border:1px solid #bae6fd;">
            ${tag}
          </span>`
        ).join("");

        // æ ¹æ“šè³‡æ–™é‡æ±ºå®š badge æ¨£å¼
        const badgeClass = totalDataCount > 10
          ? "data-badge rich-data"
          : "data-badge";

        item.innerHTML = `
          <div class="info">
            <div class="name">${name}</div>
            <div class="meta">
              ID: ${id} | ${p.gender || 'N/A'} | ${p.birthDate || ''}
            </div>
            <div style="margin-top:10px; display:flex; flex-wrap:wrap; gap:4px;">
              ${tagsHtml}
            </div>
          </div>
          <div class="${badgeClass}">
            ${totalDataCount} ç­†ç›¸é—œè³‡æ–™
          </div>
        `;

        // ================================
        // 7ï¸âƒ£ é»æ“Šå¾Œé¸å®šç—…æ‚£
        // ================================
        item.onclick = () => {
          // å°‡ç—…æ‚£ ID å­˜å…¥ sessionStorage
          sessionStorage.setItem("selected_patient_id", id);

          // é€²å…¥ä¸»å„€è¡¨æ¿é é¢
          window.location.href = "overview.html";
        };

        listContainer.appendChild(item);
      }

      // è‹¥æ‰€æœ‰ç—…æ‚£éƒ½è¢«éæ¿¾æ‰
      if (listContainer.children.length === 0) {
        document.getElementById("status").style.display = "block";
        document.getElementById("status").textContent =
          "æ‰¾ä¸åˆ°å…·å‚™è‡¨åºŠè³‡æ–™çš„æ¸¬è©¦ç—…æ‚£ã€‚";
      }

    } catch (err) {
      console.error(err);
      document.getElementById("status").textContent =
        "è®€å–å¤±æ•—ï¼Œè«‹æª¢æŸ¥æ¬Šé™æˆ–ç™»å…¥ç‹€æ…‹ã€‚";
    }
  });
</script>
</body>
</html>
